// Main Application Script
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the app
    initApp();
    
    // Check if user is logged in
    if (!isLoggedIn()) {
        window.location.href = 'index.html';
        return;
    }
    
    // Load current user data
    const currentUser = getCurrentUser();
    if (!currentUser) {
        window.location.href = 'index.html';
        return;
    }
    
    // Update UI with user data
    updateUserUI(currentUser);
    
    // Check if user is admin
    if (currentUser.username === 'saintex') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        document.getElementById('manageUsersBtn').style.display = 'inline-block';
        document.getElementById('moderateContentBtn').style.display = 'inline-block';
    }
    
    // Load initial tab
    loadTab('feed');
    
    // Event listeners
    setupEventListeners();
});

function initApp() {
    // Initialize sample data if localStorage is empty
    if (!localStorage.getItem('falaai_users')) {
        const sampleUsers = [
            {
                id: 1,
                name: "Admin User",
                username: "saintex",
                password: "ffg..1.",
                avatar: "https://randomuser.me/api/portraits/men/1.jpg",
                bio: "Administrador da FalaAI",
                isPublic: true,
                showActivity: true,
                followers: [2, 3, 4],
                following: [2, 3, 4],
                createdAt: new Date().toISOString()
            },
            {
                id: 2,
                name: "João Silva",
                username: "joaosilva",
                password: "123456",
                avatar: "https://randomuser.me/api/portraits/men/2.jpg",
                bio: "Estudante do 3º ano",
                isPublic: true,
                showActivity: true,
                followers: [1, 3],
                following: [1, 3, 4],
                createdAt: new Date().toISOString()
            },
            {
                id: 3,
                name: "Maria Oliveira",
                username: "mariaoliveira",
                password: "123456",
                avatar: "https://randomuser.me/api/portraits/women/1.jpg",
                bio: "Amo ler e escrever poesias",
                isPublic: true,
                showActivity: true,
                followers: [1, 2, 4],
                following: [1, 2],
                createdAt: new Date().toISOString()
            },
            {
                id: 4,
                name: "Carlos Souza",
                username: "carlossouza",
                password: "123456",
                avatar: "https://randomuser.me/api/portraits/men/3.jpg",
                bio: "Fã de jogos e tecnologia",
                isPublic: false,
                showActivity: false,
                followers: [1],
                following: [1, 2],
                createdAt: new Date().toISOString()
            }
        ];
        
        localStorage.setItem('falaai_users', JSON.stringify(sampleUsers));
    }
    
    if (!localStorage.getItem('falaai_posts')) {
        const samplePosts = [
            {
                id: 1,
                userId: 2,
                content: "Alguém sabe quando é a prova de matemática?",
                image: "",
                likes: [1, 3],
                comments: [
                    {
                        id: 1,
                        userId: 3,
                        content: "Acho que é semana que vem, não?",
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        userId: 1,
                        content: "Sim, dia 15 às 10h.",
                        createdAt: new Date().toISOString()
                    }
                ],
                createdAt: new Date('2023-05-10').toISOString()
            },
            {
                id: 2,
                userId: 3,
                content: "Acabei de publicar um novo poema no meu blog! O que acham?",
                image: "",
                likes: [1, 2, 4],
                comments: [
                    {
                        id: 3,
                        userId: 2,
                        content: "Adorei! Muito profundo.",
                        createdAt: new Date().toISOString()
                    }
                ],
                createdAt: new Date('2023-05-12').toISOString()
            },
            {
                id: 3,
                userId: 4,
                content: "Alguém quer jogar algo hoje à noite?",
                image: "",
                likes: [2],
                comments: [],
                createdAt: new Date('2023-05-14').toISOString()
            }
        ];
        
        localStorage.setItem('falaai_posts', JSON.stringify(samplePosts));
    }
    
    if (!localStorage.getItem('falaai_chats')) {
        const sampleChats = {
            topics: [
                {
                    id: 1,
                    name: "Cultura Pop",
                    description: "Filmes, séries, música e celebridades",
                    icon: "fas fa-film"
                },
                {
                    id: 2,
                    name: "Atualidades",
                    description: "Notícias e eventos importantes",
                    icon: "fas fa-newspaper"
                },
                {
                    id: 3,
                    name: "Escola",
                    description: "Dúvidas, trabalhos e provas",
                    icon: "fas fa-school"
                },
                {
                    id: 4,
                    name: "Jogos",
                    description: "Video games e esportes",
                    icon: "fas fa-gamepad"
                }
            ],
            messages: [
                {
                    id: 1,
                    topicId: 1,
                    userId: 2,
                    content: "Alguém viu o novo filme do Homem-Aranha?",
                    createdAt: new Date('2023-05-10T10:30:00').toISOString()
                },
                {
                    id: 2,
                    topicId: 1,
                    userId: 3,
                    content: "Sim! Está incrível, recomendo muito.",
                    createdAt: new Date('2023-05-10T11:15:00').toISOString()
                },
                {
                    id: 3,
                    topicId: 3,
                    userId: 4,
                    content: "Alguém tem o gabarito da última prova de física?",
                    createdAt: new Date('2023-05-11T09:20:00').toISOString()
                },
                {
                    id: 4,
                    topicId: 3,
                    userId: 1,
                    content: "Posso enviar por DM.",
                    createdAt: new Date('2023-05-11T09:25:00').toISOString()
                }
            ]
        };
        
        localStorage.setItem('falaai_chats', JSON.stringify(sampleChats));
    }
    
    if (!localStorage.getItem('falaai_dms')) {
        const sampleDMs = [
            {
                id: 1,
                participants: [1, 2],
                messages: [
                    {
                        id: 1,
                        senderId: 2,
                        content: "Oi admin, tudo bem?",
                        createdAt: new Date('2023-05-09T14:30:00').toISOString()
                    },
                    {
                        id: 2,
                        senderId: 1,
                        content: "Tudo ótimo, e você?",
                        createdAt: new Date('2023-05-09T14:35:00').toISOString()
                    }
                ]
            },
            {
                id: 2,
                participants: [2, 3],
                messages: [
                    {
                        id: 3,
                        senderId: 3,
                        content: "João, você vai no evento hoje?",
                        createdAt: new Date('2023-05-10T08:15:00').toISOString()
                    },
                    {
                        id: 4,
                        senderId: 2,
                        content: "Vou sim, nos vemos lá!",
                        createdAt: new Date('2023-05-10T08:20:00').toISOString()
                    }
                ]
            }
        ];
        
        localStorage.setItem('falaai_dms', JSON.stringify(sampleDMs));
    }
}

function isLoggedIn() {
    return localStorage.getItem('falaai_currentUser') !== null;
}

function getCurrentUser() {
    const userId = JSON.parse(localStorage.getItem('falaai_currentUser'));
    const users = JSON.parse(localStorage.getItem('falaai_users'));
    return users.find(user => user.id === userId);
}

function updateUserUI(user) {
    // Update header avatar
    const headerAvatar = document.getElementById('headerAvatar');
    if (headerAvatar) {
        headerAvatar.querySelector('img').src = user.avatar;
    }
    
    // Update profile page if it's the current user's profile
    if (document.getElementById('profileName')) {
        document.getElementById('profileName').textContent = user.name;
        document.getElementById('profileUsername').textContent = `@${user.username}`;
        document.getElementById('profileAvatarImg').src = user.avatar;
        document.getElementById('profileBio').textContent = user.bio || "Nenhuma biografia fornecida.";
        
        // Update stats
        document.getElementById('followerCount').textContent = user.followers ? user.followers.length : 0;
        document.getElementById('followingCount').textContent = user.following ? user.following.length : 0;
        
        // Get user posts count
        const posts = JSON.parse(localStorage.getItem('falaai_posts'));
        const userPosts = posts.filter(post => post.userId === user.id);
        document.getElementById('postCount').textContent = userPosts.length;
        
        // Hide follow button if it's the current user's profile
        document.getElementById('followBtn').style.display = 'none';
    }
}

function loadTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Update current tab title
    const tabTitle = document.getElementById('currentTabTitle');
    if (tabTitle) {
        const tabName = document.querySelector(`.nav-item[data-tab="${tabId}"] span`).textContent;
        tabTitle.textContent = tabName;
    }
    
    // Load tab specific content
    switch (tabId) {
        case 'feed':
            loadFeed();
            break;
        case 'explore':
            loadExplore();
            break;
        case 'chats':
            loadChatTopics();
            break;
        case 'messages':
            loadConversations();
            break;
        case 'profile':
            loadProfile(getCurrentUser().id);
            break;
        case 'settings':
            loadSettings();
            break;
    }
}

function loadFeed() {
    const feedContainer = document.getElementById('feed');
    const currentUser = getCurrentUser();
    const users = JSON.parse(localStorage.getItem('falaai_users'));
    const posts = JSON.parse(localStorage.getItem('falaai_posts'));
    
    // Sort posts by date (newest first)
    const sortedPosts = [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    feedContainer.innerHTML = '';
    
    if (sortedPosts.length === 0) {
        feedContainer.innerHTML = '<p class="text-muted text-center">Nenhuma postagem encontrada. Seja o primeiro a postar!</p>';
        return;
    }
    
    sortedPosts.forEach(post => {
        const user = users.find(u => u.id === post.userId);
        if (!user) return;
        
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.dataset.postId = post.id;
        
        const isLiked = post.likes && post.likes.includes(currentUser.id);
        const likeIcon = isLiked ? 'fas fa-heart' : 'far fa-heart';
        const likeClass = isLiked ? 'active' : '';
        
        const commentsCount = post.comments ? post.comments.length : 0;
        
        postElement.innerHTML = `
            <div class="post-header">
                <div class="user-avatar small">
                    <img src="${user.avatar}" alt="${user.name}">
                </div>
                <div class="post-user">
                    <div class="post-username">${user.name}</div>
                    <div class="post-time">${formatDate(post.createdAt)}</div>
                </div>
                <div class="post-options">
                    <button class="post-options-btn">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="post-options-menu">
                        ${post.userId === currentUser.id ? `
                            <button class="post-options-item danger delete-post-btn">
                                <i class="fas fa-trash"></i>
                                <span>Excluir</span>
                            </button>
                        ` : `
                            <button class="post-options-item report-post-btn">
                                <i class="fas fa-flag"></i>
                                <span>Denunciar</span>
                            </button>
                        `}
                    </div>
                </div>
            </div>
            <div class="post-content">
                ${post.content}
            </div>
            ${post.image ? `
                <img src="${post.image}" class="post-image" alt="Post image">
            ` : ''}
            <div class="post-actions">
                <button class="post-action like-btn ${likeClass}">
                    <i class="${likeIcon}"></i>
                    <span>${post.likes ? post.likes.length : 0}</span>
                </button>
                <button class="post-action comment-btn">
                    <i class="far fa-comment"></i>
                    <span>${commentsCount}</span>
                </button>
                <button class="post-action share-btn">
                    <i class="fas fa-share"></i>
                    <span>Compartilhar</span>
                </button>
            </div>
            <div class="post-comments">
                ${post.comments && post.comments.length > 0 ? `
                    ${post.comments.map(comment => {
                        const commentUser = users.find(u => u.id === comment.userId);
                        return `
                            <div class="comment" data-comment-id="${comment.id}">
                                <div class="user-avatar small">
                                    <img src="${commentUser.avatar}" alt="${commentUser.name}">
                                </div>
                                <div class="comment-content">
                                    <div class="comment-user">${commentUser.name}</div>
                                   
